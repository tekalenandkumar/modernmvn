'use client';

import React, { useEffect, useState } from 'react';
import {
    ShieldCheck, ShieldAlert, ShieldX, Shield,
    ExternalLink, ChevronDown, ChevronUp, AlertTriangle, Loader2, Info
} from 'lucide-react';
import {
    VulnerabilityReport, SecurityAdvisory, VersionIntelligence, VersionAssessment,
    fetchVulnerabilityReport, fetchVersionIntelligence,
    severityColor, severityBgColor, safetyColor, safetyBgColor,
    stabilityLabel, stabilityColor, relativeTime, safetyIcon,
} from '@/lib/security-api';

interface VulnerabilityPanelProps {
    groupId: string;
    artifactId: string;
    version: string;
}

/**
 * Full vulnerability panel for an artifact version.
 * Shows: vulnerability report, version intelligence, security disclaimer.
 */
export default function VulnerabilityPanel({ groupId, artifactId, version }: VulnerabilityPanelProps) {
    const [report, setReport] = useState<VulnerabilityReport | null>(null);
    const [intelligence, setIntelligence] = useState<VersionIntelligence | null>(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);
    const [expandedAdvisory, setExpandedAdvisory] = useState<string | null>(null);

    useEffect(() => {
        if (!groupId || !artifactId || !version) return;
        setLoading(true);
        setError(null);

        Promise.all([
            fetchVulnerabilityReport(groupId, artifactId, version).catch(() => null),
            fetchVersionIntelligence(groupId, artifactId, 8).catch(() => null),
        ]).then(([rep, intel]) => {
            setReport(rep);
            setIntelligence(intel);
        }).catch(() => setError('Failed to load security data'))
            .finally(() => setLoading(false));
    }, [groupId, artifactId, version]);

    if (loading) {
        return (
            <div style={styles.container}>
                <div style={styles.loadingState}>
                    <Loader2 size={20} style={{ animation: 'spin 1s linear infinite', color: '#a0a0a0' }} />
                    <span style={{ color: '#a0a0a0' }}>Checking security advisories...</span>
                </div>
            </div>
        );
    }

    if (error) {
        return (
            <div style={styles.container}>
                <div style={{ ...styles.loadingState, color: '#ff6b6b' }}>
                    <AlertTriangle size={16} />
                    {error}
                </div>
            </div>
        );
    }

    const hasVulns = report && report.totalVulnerabilities > 0;

    return (
        <div style={styles.container}>
            {/* Header */}
            <div style={styles.header}>
                <div style={styles.headerTitle}>
                    <Shield size={18} style={{ color: '#a78bfa' }} />
                    <h3 style={styles.title}>Security & Version Intelligence</h3>
                </div>
            </div>

            {/* Summary Cards */}
            <div style={styles.summaryGrid}>
                {/* Vulnerability Summary */}
                <div style={{
                    ...styles.summaryCard,
                    borderColor: hasVulns ? severityColor(report!.highestSeverity) + '33' : '#2ed57333',
                }}>
                    <div style={styles.summaryIconRow}>
                        {hasVulns
                            ? <ShieldAlert size={22} style={{ color: severityColor(report!.highestSeverity) }} />
                            : <ShieldCheck size={22} style={{ color: '#2ed573' }} />
                        }
                        <span style={{
                            ...styles.summaryCount,
                            color: hasVulns ? severityColor(report!.highestSeverity) : '#2ed573',
                        }}>
                            {report?.totalVulnerabilities ?? 0}
                        </span>
                    </div>
                    <span style={styles.summaryLabel}>
                        {hasVulns ? 'Known Vulnerabilities' : 'No Known Vulnerabilities'}
                    </span>
                    {hasVulns && report && (
                        <div style={styles.severityBreakdown}>
                            {report.criticalCount > 0 && <SeverityPill severity="CRITICAL" count={report.criticalCount} />}
                            {report.highCount > 0 && <SeverityPill severity="HIGH" count={report.highCount} />}
                            {report.mediumCount > 0 && <SeverityPill severity="MEDIUM" count={report.mediumCount} />}
                            {report.lowCount > 0 && <SeverityPill severity="LOW" count={report.lowCount} />}
                        </div>
                    )}
                </div>

                {/* Version Intelligence Summary */}
                {intelligence?.recommendedVersion && (
                    <div style={{
                        ...styles.summaryCard,
                        borderColor: safetyColor(intelligence.recommendedVersion.safetyIndicator) + '33',
                    }}>
                        <div style={styles.summaryIconRow}>
                            <span style={{
                                fontSize: '20px',
                                color: safetyColor(intelligence.recommendedVersion.safetyIndicator),
                            }}>
                                {safetyIcon(intelligence.recommendedVersion.safetyIndicator)}
                            </span>
                            <span style={{
                                ...styles.summaryCount,
                                color: safetyColor(intelligence.recommendedVersion.safetyIndicator),
                                fontSize: '14px',
                            }}>
                                {intelligence.recommendedVersion.safetyLabel}
                            </span>
                        </div>
                        <span style={styles.summaryLabel}>
                            Recommended: {intelligence.recommendedVersion.version}
                        </span>
                        <div style={{ display: 'flex', gap: '8px', marginTop: '6px', flexWrap: 'wrap' }}>
                            <span style={{
                                padding: '2px 8px',
                                borderRadius: '4px',
                                fontSize: '11px',
                                background: stabilityColor(intelligence.recommendedVersion.stabilityGrade) + '18',
                                color: stabilityColor(intelligence.recommendedVersion.stabilityGrade),
                                fontWeight: 500,
                            }}>
                                {stabilityLabel(intelligence.recommendedVersion.stabilityGrade)}
                            </span>
                            <span style={{
                                padding: '2px 8px',
                                borderRadius: '4px',
                                fontSize: '11px',
                                background: 'rgba(116, 125, 140, 0.1)',
                                color: '#a0a0a0',
                            }}>
                                Score: {Math.round(intelligence.recommendedVersion.stabilityScore)}/100
                            </span>
                        </div>
                    </div>
                )}
            </div>

            {/* Advisory List */}
            {hasVulns && report && (
                <div style={styles.advisorySection}>
                    <h4 style={styles.sectionTitle}>Advisories</h4>
                    {report.advisories.map((adv) => (
                        <AdvisoryCard
                            key={adv.id}
                            advisory={adv}
                            expanded={expandedAdvisory === adv.id}
                            onToggle={() => setExpandedAdvisory(
                                expandedAdvisory === adv.id ? null : adv.id
                            )}
                        />
                    ))}
                </div>
            )}

            {/* Version Intelligence Table */}
            {intelligence && intelligence.versions.length > 0 && (
                <div style={styles.advisorySection}>
                    <h4 style={styles.sectionTitle}>Version Assessment</h4>
                    <div style={styles.versionTable}>
                        <div style={styles.versionTableHeader}>
                            <span style={{ flex: 1 }}>Version</span>
                            <span style={{ width: '90px', textAlign: 'center' }}>Safety</span>
                            <span style={{ width: '80px', textAlign: 'center' }}>Stability</span>
                            <span style={{ width: '60px', textAlign: 'center' }}>Vulns</span>
                            <span style={{ width: '70px', textAlign: 'center' }}>Score</span>
                        </div>
                        {intelligence.versions.map((va) => (
                            <VersionRow key={va.version} assessment={va} currentVersion={version} />
                        ))}
                    </div>
                </div>
            )}

            {/* Disclaimer */}
            <div style={styles.disclaimer}>
                <Info size={14} style={{ flexShrink: 0, marginTop: '1px' }} />
                <span>{report?.disclaimer || VulnerabilityReport_DISCLAIMER}</span>
            </div>
        </div>
    );
}

// ─── Sub-components ──────────────────────────────────────────────

function SeverityPill({ severity, count }: { severity: string; count: number }) {
    return (
        <span style={{
            display: 'inline-flex',
            alignItems: 'center',
            gap: '4px',
            padding: '2px 8px',
            borderRadius: '4px',
            fontSize: '11px',
            fontWeight: 600,
            background: severityBgColor(severity),
            color: severityColor(severity),
        }}>
            {count} {severity}
        </span>
    );
}

function AdvisoryCard({ advisory, expanded, onToggle }: {
    advisory: SecurityAdvisory;
    expanded: boolean;
    onToggle: () => void;
}) {
    const color = severityColor(advisory.severity);

    return (
        <div style={{
            ...styles.advisoryCard,
            borderLeftColor: color,
        }}>
            <div
                style={styles.advisoryHeader}
                onClick={onToggle}
                role="button"
                tabIndex={0}
                onKeyDown={(e) => { if (e.key === 'Enter') onToggle(); }}
            >
                <div style={{ flex: 1 }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', flexWrap: 'wrap' }}>
                        <span style={{
                            padding: '2px 8px',
                            borderRadius: '4px',
                            fontSize: '10px',
                            fontWeight: 700,
                            textTransform: 'uppercase' as const,
                            background: severityBgColor(advisory.severity),
                            color: color,
                            letterSpacing: '0.05em',
                        }}>
                            {advisory.severity}
                        </span>
                        <span style={{ fontSize: '13px', fontWeight: 600, color: '#e0e0e0' }}>
                            {advisory.id}
                        </span>
                        {advisory.aliases.filter(a => a !== advisory.id && a.startsWith('CVE-')).map(alias => (
                            <span key={alias} style={{
                                fontSize: '11px',
                                color: '#888',
                                fontFamily: 'monospace',
                            }}>
                                {alias}
                            </span>
                        ))}
                    </div>
                    <p style={styles.advisorySummary}>{advisory.summary}</p>
                </div>
                {expanded ? <ChevronUp size={16} color="#888" /> : <ChevronDown size={16} color="#888" />}
            </div>

            {expanded && (
                <div style={styles.advisoryDetails}>
                    {advisory.details && (
                        <p style={{ fontSize: '13px', color: '#a0a0a0', lineHeight: 1.6, margin: '0 0 12px' }}>
                            {advisory.details.length > 500
                                ? advisory.details.substring(0, 500) + '...'
                                : advisory.details}
                        </p>
                    )}

                    <div style={{ display: 'flex', gap: '16px', flexWrap: 'wrap', fontSize: '12px' }}>
                        {advisory.fixedVersion && (
                            <span style={{ color: '#2ed573' }}>
                                ✓ Fixed in <strong>{advisory.fixedVersion}</strong>
                            </span>
                        )}
                        {advisory.published && (
                            <span style={{ color: '#888' }}>
                                Published: {relativeTime(advisory.published)}
                            </span>
                        )}
                        {advisory.cweIds.length > 0 && (
                            <span style={{ color: '#888' }}>
                                CWE: {advisory.cweIds.join(', ')}
                            </span>
                        )}
                    </div>

                    {advisory.referenceUrl && (
                        <a
                            href={advisory.referenceUrl}
                            target="_blank"
                            rel="noopener noreferrer"
                            style={styles.advisoryLink}
                        >
                            View Advisory <ExternalLink size={12} />
                        </a>
                    )}
                </div>
            )}
        </div>
    );
}

function VersionRow({ assessment, currentVersion }: {
    assessment: VersionAssessment;
    currentVersion: string;
}) {
    const isCurrent = assessment.version === currentVersion;
    const sc = safetyColor(assessment.safetyIndicator);

    return (
        <div style={{
            ...styles.versionRow,
            background: isCurrent ? 'rgba(167, 139, 250, 0.06)' : 'transparent',
            borderLeft: isCurrent ? '2px solid #a78bfa' : '2px solid transparent',
        }}>
            <span style={{ flex: 1, display: 'flex', alignItems: 'center', gap: '6px' }}>
                <code style={{ fontSize: '12px', color: isCurrent ? '#a78bfa' : '#e0e0e0' }}>
                    {assessment.version}
                </code>
                {isCurrent && (
                    <span style={{
                        fontSize: '9px',
                        padding: '1px 5px',
                        borderRadius: '3px',
                        background: 'rgba(167, 139, 250, 0.15)',
                        color: '#a78bfa',
                        fontWeight: 600,
                    }}>
                        CURRENT
                    </span>
                )}
                {!assessment.isRelease && (
                    <span style={{
                        fontSize: '9px',
                        padding: '1px 5px',
                        borderRadius: '3px',
                        background: 'rgba(255, 165, 2, 0.12)',
                        color: '#ffa502',
                        fontWeight: 500,
                    }}>
                        PRE
                    </span>
                )}
            </span>
            <span style={{
                width: '90px',
                textAlign: 'center',
                display: 'flex',
                justifyContent: 'center',
            }}>
                <span style={{
                    padding: '2px 10px',
                    borderRadius: '9999px',
                    fontSize: '10px',
                    fontWeight: 600,
                    background: safetyBgColor(assessment.safetyIndicator),
                    color: sc,
                    textTransform: 'uppercase' as const,
                }}>
                    {assessment.safetyIndicator}
                </span>
            </span>
            <span style={{
                width: '80px',
                textAlign: 'center',
                fontSize: '11px',
                color: stabilityColor(assessment.stabilityGrade),
            }}>
                {stabilityLabel(assessment.stabilityGrade)}
            </span>
            <span style={{
                width: '60px',
                textAlign: 'center',
                fontSize: '12px',
                fontWeight: assessment.vulnerabilityCount > 0 ? 600 : 400,
                color: assessment.vulnerabilityCount > 0
                    ? severityColor(assessment.highestSeverity)
                    : '#2ed573',
            }}>
                {assessment.vulnerabilityCount}
            </span>
            <span style={{
                width: '70px',
                textAlign: 'center',
                fontSize: '12px',
                color: '#a0a0a0',
            }}>
                {Math.round(assessment.stabilityScore)}
            </span>
        </div>
    );
}

// ─── Styles ──────────────────────────────────────────────────────

const VulnerabilityReport_DISCLAIMER =
    "Security data is sourced from OSV.dev and may not be exhaustive. " +
    "This information is provided as-is for informational purposes only. " +
    "Always conduct your own security review before using any library in production.";

const styles: Record<string, React.CSSProperties> = {
    container: {
        background: 'rgba(15, 15, 25, 0.6)',
        border: '1px solid rgba(255,255,255,0.06)',
        borderRadius: '12px',
        padding: '24px',
        marginTop: '20px',
        backdropFilter: 'blur(10px)',
    },
    loadingState: {
        display: 'flex',
        alignItems: 'center',
        gap: '10px',
        justifyContent: 'center',
        padding: '20px',
        fontSize: '14px',
    },
    header: {
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        marginBottom: '20px',
    },
    headerTitle: {
        display: 'flex',
        alignItems: 'center',
        gap: '10px',
    },
    title: {
        margin: 0,
        fontSize: '16px',
        fontWeight: 600,
        color: '#e0e0e0',
    },
    summaryGrid: {
        display: 'grid',
        gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))',
        gap: '16px',
        marginBottom: '20px',
    },
    summaryCard: {
        background: 'rgba(255,255,255,0.03)',
        border: '1px solid rgba(255,255,255,0.06)',
        borderRadius: '10px',
        padding: '18px',
    },
    summaryIconRow: {
        display: 'flex',
        alignItems: 'center',
        gap: '10px',
        marginBottom: '8px',
    },
    summaryCount: {
        fontSize: '24px',
        fontWeight: 700,
    },
    summaryLabel: {
        fontSize: '13px',
        color: '#a0a0a0',
    },
    severityBreakdown: {
        display: 'flex',
        gap: '6px',
        flexWrap: 'wrap' as const,
        marginTop: '10px',
    },
    advisorySection: {
        marginTop: '20px',
    },
    sectionTitle: {
        fontSize: '14px',
        fontWeight: 600,
        color: '#c0c0c0',
        marginBottom: '12px',
    },
    advisoryCard: {
        background: 'rgba(255,255,255,0.02)',
        border: '1px solid rgba(255,255,255,0.05)',
        borderLeft: '3px solid',
        borderRadius: '8px',
        marginBottom: '8px',
        overflow: 'hidden',
    },
    advisoryHeader: {
        display: 'flex',
        alignItems: 'flex-start',
        gap: '12px',
        padding: '14px 16px',
        cursor: 'pointer',
    },
    advisorySummary: {
        fontSize: '13px',
        color: '#a0a0a0',
        margin: '4px 0 0',
        lineHeight: 1.4,
    },
    advisoryDetails: {
        padding: '0 16px 16px',
        borderTop: '1px solid rgba(255,255,255,0.04)',
        paddingTop: '12px',
    },
    advisoryLink: {
        display: 'inline-flex',
        alignItems: 'center',
        gap: '4px',
        marginTop: '10px',
        fontSize: '12px',
        color: '#a78bfa',
        textDecoration: 'none',
    },
    versionTable: {
        border: '1px solid rgba(255,255,255,0.06)',
        borderRadius: '8px',
        overflow: 'hidden',
    },
    versionTableHeader: {
        display: 'flex',
        alignItems: 'center',
        padding: '10px 16px',
        fontSize: '11px',
        fontWeight: 600,
        color: '#888',
        textTransform: 'uppercase' as const,
        letterSpacing: '0.05em',
        background: 'rgba(255,255,255,0.03)',
        borderBottom: '1px solid rgba(255,255,255,0.06)',
    },
    versionRow: {
        display: 'flex',
        alignItems: 'center',
        padding: '10px 16px',
        borderBottom: '1px solid rgba(255,255,255,0.03)',
        transition: 'background 0.15s',
    },
    disclaimer: {
        display: 'flex',
        alignItems: 'flex-start',
        gap: '8px',
        marginTop: '20px',
        padding: '12px 16px',
        borderRadius: '8px',
        background: 'rgba(167, 139, 250, 0.05)',
        border: '1px solid rgba(167, 139, 250, 0.1)',
        fontSize: '11px',
        color: '#888',
        lineHeight: 1.5,
    },
};
